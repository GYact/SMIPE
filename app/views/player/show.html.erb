<div class="player-container">
  <main class="player-content" data-controller="player" data-player-playing-value="false"
    data-player-token="<%= @access_token %>"
    data-player-track-uris="<%= @all_track_uris.to_json %>"
    data-player-selected-playlist-id="<%= @selected_playlist_id %>"
    data-action="swipeRight->player#handleSwipeRight
                 swipeLeft->player#handleSwipeLeft
                 swipeUp->player#handleSwipeUp
                 swipeDown->player#handleSwipeDown">
    <div class="album-art-section" id="album-art-section" data-player-target="albumArt">
      <% if @first_track && @first_track.album && @first_track.album.images.any? %>
        <%= image_tag @first_track.album.images.first['url'], alt: "Album Art", class: "album-image", data: { player_target: "albumImage" } %>
      <% else %>
        <%= image_tag "image.png", alt: "Album Art", class: "album-image", data: { player_target: "albumImage" } %>
      <% end %>

      <!-- スワイプインジケーター -->
      <div class="swipe-indicator right">
        <i class="fas fa-heart"></i>
      </div>
      <div class="swipe-indicator left">
        <i class="fas fa-times"></i>
      </div>
      <div class="swipe-indicator up">
        <i class="fas fa-chevron-up"></i>
      </div>
      <div class="swipe-indicator down">
        <i class="fas fa-chevron-down"></i>
      </div>
      
      <!-- スワイプ中の視覚的フィードバック -->
      <div class="swiping"></div>

      <div class="track-details">
        <p class="song-title" data-player-target="songTitle"><%= @first_track&.name || 'No Track' %></p>
        <p class="artist-name" data-player-target="artistName"><%= @first_track&.artists&.map(&:name)&.join(', ') || 'Unknown Artist' %></p>
      </div>
    </div>

    <div class="player-actions">
      <button class="action-button delete-button" id="delete-button" data-player-target="deleteButton" data-action="click->player#handleDelete">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 3v1H4v2h1v13c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V6h1V4h-5V3H9zm0 5h2v9H9V8zm4 0h2v9h-2V8z"/>
        </svg>
        <span>Delete</span>
      </button>
      <button id="play-pause-btn" class="action-button play-button" data-action="click->player#togglePlay" data-player-target="playPauseButton" disabled>
        <svg id="play-icon" data-player-target="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <svg id="pause-icon" data-player-target="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
        <span data-player-target="playLabel">PLAY</span>
      </button>
      <button class="action-button shuffle-button" id="shuffle-button" data-player-target="shuffleButton" data-action="click->player#toggleShuffle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zM14.83 13.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
        </svg>
        <span>Shuffle</span>
      </button>
      <button class="action-button skip-button" id="skip-button" data-player-target="skipButton" data-action="click->player#handleSkip">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
        </svg>
        <span>Skip</span>
      </button>
      <button class="action-button like-button" id="like-button" data-player-target="likeButton" data-action="click->player#toggleLike">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
        </svg>
        <span>Like</span>
      </button>
    </div>

    <div class="playlist-selection">
      <button id="toggle-playlist-selection" class="playlist-selection-button" data-player-target="togglePlaylistSelectionButton" data-action="click->player#togglePlaylistSelection">
        <i class="fas fa-list"></i> プレイリストの変更
      </button>
      <div id="playlist-selection-panel" class="playlist-selection-panel" style="display: none;" data-player-target="playlistSelectionPanel">
        <h4>プレイリストを選択</h4>
        <div class="playlist-list" data-player-target="selectedPlaylistRadios" data-action="change->player#handlePlaylistSelectionChange">
          <% @playlists.each do |playlist| %>
            <div class="playlist-option">
              <input type="radio" 
                     name="selected_playlist" 
                     id="playlist_<%= playlist.id %>" 
                     value="<%= playlist.id %>"
                     data-playlist-name="<%= playlist.name %>"
                     <%= playlist.id == @selected_playlist_id ? 'checked' : '' %>>
              <label for="playlist_<%= playlist.id %>">
                <%= playlist.name %>
                <span class="track-count">(<%= playlist.tracks.count %>曲)</span>
              </label>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <section class="up-next">
      <h3>Up Next</h3>
      <div class="up-next-items" id="up-next-items" data-player-target="upNextItems">
        <!-- Up Next items will be inserted here dynamically -->
      </div>
    </section>
  </main>
</div>

<% if @first_track_uri.present? && @all_track_uris.present? %>
  <meta name="selected-playlist-id" content="<%= @selected_playlist_id %>">

  <div data-controller="spotify-player" data-spotify-player-token-value="<%= @access_token %>"></div>

  <style>
    .playlist-selection {
      margin-top: 20px;
      padding: 0 20px;
    }

    .playlist-selection-button {
      width: 100%;
      padding: 12px;
      background: #282828;
      border: none;
      border-radius: 8px;
      color: #FFFFFF;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s;
    }

    .playlist-selection-button:hover {
      background: #383838;
    }

    .playlist-selection-panel {
      margin-top: 16px;
      padding: 16px;
      background: #282828;
      border-radius: 8px;
    }

    .playlist-selection-panel h4 {
      color: #FFFFFF;
      margin: 0 0 16px 0;
      font-size: 16px;
    }

    .playlist-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .playlist-option {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .playlist-option label {
      color: #FFFFFF;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .track-count {
      color: #B3B3B3;
      font-size: 0.9em;
    }

    input[type="radio"] {
      accent-color: #1DB954;
    }
  </style>

  
<% end %>

<style>
.album-art-section {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
}

.album-image {
  width: 300px;
  height: 300px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 20px;
  will-change: transform;
  touch-action: none;
}

.track-details {
  text-align: center;
}

.song-title {
  font-size: 1.5em;
  font-weight: bold;
  margin: 0;
}

.artist-name {
  color: #B3B3B3;
  margin: 5px 0;
}
</style>